#!/usr/bin/env node
(function () {var u,b={};Object.defineProperty(b,"__esModule",{value:!0});var D=(y=void 0,t=b.getPackagesFolderName=y,w=b.getOutFolder=t,u=b.DEFAULT_RUNNER=w,b.WorkingFiles=u);b.Tasks=D;var y=e=>{var r;return(null===(r=null==e?void 0:e.fireConfig)||void 0===r?void 0:r.outFolderName)||".packages"};b.getPackagesFolderName=y;var t=e=>{var r;return(null===(r=null==e?void 0:e.fireConfig)||void 0===r?void 0:r.outFolderLocation)||"."};b.getOutFolder=t;var la,ka,w="firebase";b.DEFAULT_RUNNER=w,function(e){e.PACKAGE_JSON="package.json",e.PACKAGE_TEMP_JSON="package.temp.json"}(la=b.WorkingFiles||(u={},b.WorkingFiles=u)),function(e){e.REVERT="--revert-changes",e.BUILD="--buildCommand",e.LEAVE_CHANGES="--leave-changes"}(ka=b.Tasks||(D={},b.Tasks=D));var c={};Object.defineProperty(c,"__esModule",{value:!0});var B=(F=void 0,c.includes=F);c.nextOrDefault=B;var F=e=>process.argv.toString().includes(e);c.includes=F,B=(e,r=!0,$=e=>e)=>{if(process.argv.toString().includes(b.Tasks[e])){const t=process.argv[process.argv.indexOf(e)+1];return t?t.includes("--")?r:$(t):r}return r},c.nextOrDefault=B;var o={};Object.defineProperty(o,"__esModule",{value:!0});var i=void 0;o.Worker=i;const H=require("child_process");i=({command:r,args:e,cwd:o}={command:"npx",args:[]},s=!0)=>new Promise(($,p)=>{const t=H.spawn(r,e,{cwd:o});s&&(t.stderr.pipe(process.stderr),t.stdout.pipe(process.stdout)),t.on("close",r=>0!==r?p(!!r):$(!!r))}),o.Worker=i;var e={},x=e&&e.__awaiter||function(r,$,e,a){return new(e||(e=Promise))(function(s,c){function u(r){try{i(a.next(r))}catch($){c($)}}function t(r){try{i(a.throw(r))}catch($){c($)}}function i(r){var $;r.done?s(r.value):($=r.value,$ instanceof e?$:new e(function(r){r($)})).then(u,t)}i((a=a.apply(r,$||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});var p=void 0;e.buildPackages=p;const K=require("fs"),z=require("path"),U=require("util");function fa(r,$){return x(this,void 0,void 0,function*(){return yield Promise.all((yield U.promisify(K.readdir)(z.join(r,$))).map(e=>x(this,void 0,void 0,function*(){yield i({command:"npx",args:c.nextOrDefault(b.Tasks.BUILD,"tsc").split(" "),cwd:z.join(r,$,e)},!1)})))})}p=fa,e.buildPackages=p;var g={},G=g&&g.__awaiter||function(e,r,$,o){return new($||($=Promise))(function(a,c){function t(e){try{n(o.next(e))}catch(r){c(r)}}function Q(e){try{n(o.throw(e))}catch(r){c(r)}}function n(e){var r;e.done?a(e.value):(r=e.value,r instanceof $?r:new $(function(e){e(r)})).then(t,Q)}n((o=o.apply(e,r||[])).next())})};Object.defineProperty(g,"__esModule",{value:!0});var E=void 0;g.copyPackages=E;function M(e,r,$){return G(this,void 0,void 0,function*(){yield Promise.all(e.map(({folder:e})=>G(this,void 0,void 0,function*(){yield i({command:"rsync",args:["-r","--exclude","node_modules","--exclude","dist","--exclude",".cache",e,`${r}/${$}`]})})))})}E=M,g.copyPackages=E;var l={},Q=l&&l.__awaiter||function(t,e,$,r){return new($||($=Promise))(function(i,s){function o(t){try{a(r.next(t))}catch(e){s(e)}}function n(t){try{a(r.throw(t))}catch(e){s(e)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof $?e:new $(function(t){t(e)})).then(o,n)}a((r=r.apply(t,e||[])).next())})};Object.defineProperty(l,"__esModule",{value:!0});var r=void 0;l.fileExists=r;const W=require("fs"),_=require("util");function ba(t){return Q(this,void 0,void 0,function*(){try{return yield _.promisify(W.stat)(t),!0}catch(e){if("ENOENT"===e.code)return!1;throw e}})}r=ba,l.fileExists=r;var f={};Object.defineProperty(f,"__esModule",{value:!0});var v=void 0;f.writeFileJson=v;const ja=require("fs"),I=require("path");function J(e,$){ja.writeFileSync(I.join(process.cwd(),e),JSON.stringify($,null,2),{encoding:"utf-8"})}v=J,f.writeFileJson=v;var j={},L=j&&j.__awaiter||function(e,n,a,r){return new(a||(a=Promise))(function($,t){function i(e){try{o(r.next(e))}catch(n){t(n)}}function l(e){try{o(r.throw(e))}catch(n){t(n)}}function o(e){var n;e.done?$(e.value):(n=e.value,n instanceof a?n:new a(function(e){e(n)})).then(i,l)}o((r=r.apply(e,n||[])).next())})};Object.defineProperty(j,"__esModule",{value:!0});var d=void 0;j.exitHandler=d;function N(e){return L(this,void 0,void 0,function*(){c.includes(b.Tasks.LEAVE_CHANGES)?(yield r(b.WorkingFiles.PACKAGE_TEMP_JSON))||f.writeFileJson(b.WorkingFiles.PACKAGE_TEMP_JSON,e):f.writeFileJson(b.WorkingFiles.PACKAGE_JSON,e),process.exit()})}d=N,j.exitHandler=d;var h={},P=h&&h.__awaiter||function($,e,o,n){return new(o||(o=Promise))(function(i,t){function r($){try{s(n.next($))}catch(e){t(e)}}function p($){try{s(n.throw($))}catch(e){t(e)}}function s($){var e;$.done?i($.value):(e=$.value,e instanceof o?e:new o(function($){$(e)})).then(r,p)}s((n=n.apply($,e||[])).next())})};Object.defineProperty(h,"__esModule",{value:!0});var A=void 0;h.modifyJson=A;const R=require("fs"),S=require("util");function T($,e,o,n){return P(this,void 0,void 0,function*(){for(const{dep:i}of e)$.dependencies[i]=`file:${o}/${n}/${i.includes("/")?i.split("/")[1]:i}`;yield S.promisify(R.writeFile)(b.WorkingFiles.PACKAGE_JSON,JSON.stringify($,null,2),{encoding:"utf-8"})})}A=T,h.modifyJson=A;var a={},V=a&&a.__awaiter||function(r,$,e,t){return new(e||(e=Promise))(function(n,o){function a(r){try{s(t.next(r))}catch($){o($)}}function i(r){try{s(t.throw(r))}catch($){o($)}}function s(r){var $;r.done?n(r.value):($=r.value,$ instanceof e?$:new e(function(r){r($)})).then(a,i)}s((t=t.apply(r,$||[])).next())})};Object.defineProperty(a,"__esModule",{value:!0});var C=void 0;a.readJson=C;const X=require("fs"),Y=require("path"),Z=require("util");function $(r,$=process.cwd()){return V(this,void 0,void 0,function*(){return JSON.parse((yield Z.promisify(X.readFile)(Y.join($,r),{encoding:"utf-8"})))})}C=$,a.readJson=C;var n={},aa=n&&n.__awaiter||function(r,e,n,$){return new(n||(n=Promise))(function(t,o){function i(r){try{w($.next(r))}catch(e){o(e)}}function a(r){try{w($.throw(r))}catch(e){o(e)}}function w(r){var e;r.done?t(r.value):(e=r.value,e instanceof n?e:new n(function(r){r(e)})).then(i,a)}w(($=$.apply(r,e||[])).next())})};Object.defineProperty(n,"__esModule",{value:!0});var s=void 0;n.revertJson=s;const ca=require("fs"),da=require("util");function ea(r,e){return aa(this,void 0,void 0,function*(){const n=yield a.readJson(e);f.writeFileJson(r,n),yield da.promisify(ca.unlink)(e)})}s=ea,n.revertJson=s;var k={},ga=k&&k.__awaiter||function(r,e,$,a){return new($||($=Promise))(function(n,i){function t(r){try{s(a.next(r))}catch(e){i(e)}}function o(r){try{s(a.throw(r))}catch(e){i(e)}}function s(r){var e;r.done?n(r.value):(e=r.value,e instanceof $?e:new $(function(r){r(e)})).then(t,o)}s((a=a.apply(r,e||[])).next())})};Object.defineProperty(k,"__esModule",{value:!0});var q=void 0;k.createVirtualSymlink=q;function ia(r={},e,$){return ga(this,void 0,void 0,function*(){r.fireConfig=r.fireConfig||{};const a=r.fireConfig.runner||b.DEFAULT_RUNNER;if(c.includes(b.Tasks.REVERT))return yield s(b.WorkingFiles.PACKAGE_JSON,b.WorkingFiles.PACKAGE_TEMP_JSON);const n=JSON.parse(JSON.stringify(r));if(r.fireDependencies){const a=r.fireDependencies,t=Object.keys(a).map(r=>({dep:r,folder:a[r]}));if(yield g.copyPackages(t,e,$),c.includes(b.Tasks.BUILD))try{yield p(e,$)}catch(i){}process.stdin.resume(),process.on("exit",()=>d(n)),process.on("SIGINT",()=>d(n)),process.on("SIGUSR1",()=>d(n)),process.on("SIGUSR2",()=>d(n)),process.on("uncaughtException",()=>d(n)),yield h.modifyJson(r,t,e,$)}yield i({command:"npx",args:[a,...process.argv.slice(2).filter(r=>r!==b.Tasks.LEAVE_CHANGES&&r!==b.Tasks.REVERT&&r!==b.Tasks.BUILD)]}),d(n)})}q=ia,k.createVirtualSymlink=q;var m={},O=m&&m.__awaiter||function(e,r,n,t){return new(n||(n=Promise))(function(c,$){function a(e){try{o(t.next(e))}catch(r){$(r)}}function i(e){try{o(t.throw(e))}catch(r){$(r)}}function o(e){var r;e.done?c(e.value):(r=e.value,r instanceof n?r:new n(function(e){e(r)})).then(a,i)}o((t=t.apply(e,r||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});function ha(){return O(this,void 0,void 0,function*(){try{const r=yield a.readJson(b.WorkingFiles.PACKAGE_JSON);yield q(r,b.getOutFolder(r),b.getPackagesFolderName(r))}catch(e){console.log(e)}})}ha();if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=m}else if(typeof define==="function"&&define.amd){define(function(){return m})}})();