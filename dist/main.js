#!/usr/bin/env node
(function () {var r,a={};Object.defineProperty(a,"__esModule",{value:!0});var s=(t=void 0,u=a.linkedPackagesName=t,r=a.DEFAULT_RUNNER=u,a.WorkingFiles=r);a.Tasks=s;var t=".packages";a.linkedPackagesName=t;var fa,ga,u="firebase";a.DEFAULT_RUNNER=u,function(e){e.PACKAGE_JSON="package.json",e.PACKAGE_TEMP_JSON="package.temp.json"}(fa=a.WorkingFiles||(r={},a.WorkingFiles=r)),function(e){e.REVERT="--revert-changes",e.BUILD="--buildCommand",e.LEAVE_CHANGES="--leave-changes"}(ga=a.Tasks||(s={},a.Tasks=s));var b={};Object.defineProperty(b,"__esModule",{value:!0});var v=(w=void 0,b.includes=w);b.nextOrDefault=v;var w=e=>process.argv.toString().includes(e);b.includes=w,v=(e,r=!0,$=e=>e)=>{if(process.argv.toString().includes(a.Tasks[e])){const t=process.argv[process.argv.indexOf(e)+1];return t?t.includes("--")?r:$(t):r}return r},b.nextOrDefault=v;var n={};Object.defineProperty(n,"__esModule",{value:!0});var i=void 0;n.Worker=i;const E=require("child_process");i=({command:r,args:e,cwd:o}={command:"npx",args:[]},s=!0)=>new Promise(($,p)=>{const t=E.spawn(r,e,{cwd:o});s&&(t.stderr.pipe(process.stderr),t.stdout.pipe(process.stdout)),t.on("close",r=>0!==r?p(!!r):$(!!r))}),n.Worker=i;var e={},x=e&&e.__awaiter||function($,e,r,a){return new(r||(r=Promise))(function(s,c){function t($){try{i(a.next($))}catch(e){c(e)}}function u($){try{i(a.throw($))}catch(e){c(e)}}function i($){var e;$.done?s($.value):(e=$.value,e instanceof r?e:new r(function($){$(e)})).then(t,u)}i((a=a.apply($,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});var o=void 0;e.buildPackages=o;const F=require("fs"),y=require("path"),G=require("util");function H(){return x(this,void 0,void 0,function*(){return yield Promise.all((yield G.promisify(F.readdir)(y.join(process.cwd(),a.linkedPackagesName))).map($=>x(this,void 0,void 0,function*(){yield i({command:"npx",args:b.nextOrDefault(a.Tasks.BUILD,"tsc").split(" "),cwd:y.join(process.cwd(),a.linkedPackagesName,$)},!1)})))})}o=H,e.buildPackages=o;var f={},z=f&&f.__awaiter||function(e,$,o,r){return new(o||(o=Promise))(function(a,t){function c(e){try{Q(r.next(e))}catch($){t($)}}function n(e){try{Q(r.throw(e))}catch($){t($)}}function Q(e){var $;e.done?a(e.value):($=e.value,$ instanceof o?$:new o(function(e){e($)})).then(c,n)}Q((r=r.apply(e,$||[])).next())})};Object.defineProperty(f,"__esModule",{value:!0});var A=void 0;f.copyPackages=A;function I(e){return z(this,void 0,void 0,function*(){yield Promise.all(e.map(({folder:e})=>z(this,void 0,void 0,function*(){const $=["-r","--exclude","node_modules","--exclude","dist","--exclude",".cache",e,`./${a.linkedPackagesName}`];yield i({command:"rsync",args:$})})))})}A=I,f.copyPackages=A;var g={};Object.defineProperty(g,"__esModule",{value:!0});var B=void 0;g.writeFileJson=B;const J=require("fs"),K=require("path");function L(e,$){J.writeFileSync(K.join(process.cwd(),e),JSON.stringify($,null,2),{encoding:"utf-8"})}B=L,g.writeFileJson=B;var j={},M=j&&j.__awaiter||function(e,n,r,$){return new(r||(r=Promise))(function(a,t){function i(e){try{o($.next(e))}catch(n){t(n)}}function l(e){try{o($.throw(e))}catch(n){t(n)}}function o(e){var n;e.done?a(e.value):(n=e.value,n instanceof r?n:new r(function(e){e(n)})).then(i,l)}o(($=$.apply(e,n||[])).next())})};Object.defineProperty(j,"__esModule",{value:!0});var c=void 0;j.exitHandler=c;const N=require("fs"),O=require("util");function P(e){return M(this,void 0,void 0,function*(){b.includes(a.Tasks.LEAVE_CHANGES)?(yield O.promisify(N.exists)(a.WorkingFiles.PACKAGE_TEMP_JSON))||g.writeFileJson(a.WorkingFiles.PACKAGE_TEMP_JSON,e):g.writeFileJson(a.WorkingFiles.PACKAGE_JSON,e),process.exit()})}c=P,j.exitHandler=c;var h={},Q=h&&h.__awaiter||function(e,$,n,o){return new(n||(n=Promise))(function(i,t){function r(e){try{s(o.next(e))}catch($){t($)}}function p(e){try{s(o.throw(e))}catch($){t($)}}function s(e){var $;e.done?i(e.value):($=e.value,$ instanceof n?$:new n(function(e){e($)})).then(r,p)}s((o=o.apply(e,$||[])).next())})};Object.defineProperty(h,"__esModule",{value:!0});var C=void 0;h.modifyJson=C;const R=require("fs"),S=require("util");function T(e,$){return Q(this,void 0,void 0,function*(){for(const{dep:n}of $)e.dependencies[n]=`file:./${a.linkedPackagesName}/${n.includes("/")?n.split("/")[1]:n}`;yield S.promisify(R.writeFile)(a.WorkingFiles.PACKAGE_JSON,JSON.stringify(e,null,2),{encoding:"utf-8"})})}C=T,h.modifyJson=C;var d={},U=d&&d.__awaiter||function(r,$,e,t){return new(e||(e=Promise))(function(n,o){function a(r){try{s(t.next(r))}catch($){o($)}}function i(r){try{s(t.throw(r))}catch($){o($)}}function s(r){var $;r.done?n(r.value):($=r.value,$ instanceof e?$:new e(function(r){r($)})).then(a,i)}s((t=t.apply(r,$||[])).next())})};Object.defineProperty(d,"__esModule",{value:!0});var D=void 0;d.readJson=D;const V=require("fs"),W=require("path"),X=require("util");function Y(r){return U(this,void 0,void 0,function*(){return JSON.parse((yield X.promisify(V.readFile)(W.join(process.cwd(),r),{encoding:"utf-8"})))})}D=Y,d.readJson=D;var k={},Z=k&&k.__awaiter||function(r,e,n,$){return new(n||(n=Promise))(function(t,o){function i(r){try{w($.next(r))}catch(e){o(e)}}function a(r){try{w($.throw(r))}catch(e){o(e)}}function w(r){var e;r.done?t(r.value):(e=r.value,e instanceof n?e:new n(function(r){r(e)})).then(i,a)}w(($=$.apply(r,e||[])).next())})};Object.defineProperty(k,"__esModule",{value:!0});var p=void 0;k.revertJson=p;const $=require("fs"),_=require("util");function aa(r,e){return Z(this,void 0,void 0,function*(){const n=yield d.readJson(e);g.writeFileJson(r,n),yield _.promisify($.unlink)(e)})}p=aa,k.revertJson=p;var l={},ba=l&&l.__awaiter||function(r,e,$,a){return new($||($=Promise))(function(n,i){function t(r){try{s(a.next(r))}catch(e){i(e)}}function o(r){try{s(a.throw(r))}catch(e){i(e)}}function s(r){var e;r.done?n(r.value):(e=r.value,e instanceof $?e:new $(function(r){r(e)})).then(t,o)}s((a=a.apply(r,e||[])).next())})};Object.defineProperty(l,"__esModule",{value:!0});var q=void 0;l.createVirtualSymlink=q;function ca(){return ba(this,void 0,void 0,function*(){const r=yield d.readJson(a.WorkingFiles.PACKAGE_JSON);r.fireConfig=r.fireConfig||{};const e=r.fireConfig.runner||a.DEFAULT_RUNNER;if(b.includes(a.Tasks.REVERT))return yield p(a.WorkingFiles.PACKAGE_JSON,a.WorkingFiles.PACKAGE_TEMP_JSON);const $=JSON.parse(JSON.stringify(r));if(r.fireDependencies){const e=r.fireDependencies,n=Object.keys(e).map(r=>({dep:r,folder:e[r]}));if(yield f.copyPackages(n),b.includes(a.Tasks.BUILD))try{yield o()}catch(a){}process.stdin.resume(),process.on("exit",()=>c($)),process.on("SIGINT",()=>c($)),process.on("SIGUSR1",()=>c($)),process.on("SIGUSR2",()=>c($)),process.on("uncaughtException",()=>c($)),yield h.modifyJson(r,n)}yield i({command:"npx",args:[e,...process.argv.slice(2).filter(r=>r!==a.Tasks.LEAVE_CHANGES&&r!==a.Tasks.REVERT&&r!==a.Tasks.BUILD)]}),c($)})}q=ca,l.createVirtualSymlink=q;var m={},da=m&&m.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(c,a){function i(t){try{o(n.next(t))}catch(e){a(e)}}function $(t){try{o(n.throw(t))}catch(e){a(e)}}function o(t){var e;t.done?c(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(i,$)}o((n=n.apply(t,e||[])).next())})};Object.defineProperty(m,"__esModule",{value:!0});function ea(){return da(this,void 0,void 0,function*(){try{yield q()}catch(t){console.log(t)}})}ea();if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=m}else if(typeof define==="function"&&define.amd){define(function(){return m})}})();